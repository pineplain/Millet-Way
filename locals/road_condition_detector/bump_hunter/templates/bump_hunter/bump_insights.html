{% extends "base.html" %}

{% block title %}Bump Chart{% endblock title %}

{% block content %}
<div class="container-fluid">
  <div id="loader-bg">
    <div id="loader">
      <img src="/static/image/img-loading.gif" width="80" height="80" alt="Now Loading..." />
      <p>Now Loading...</p>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6">
      <h3 class="page-header">Bump Insights<br><span class="text-muted">You can register your insight here</span></h3>      
      <form class="form-horizontal" method="POST">
        {% csrf_token %}
        <div class="form-group">
          <label for="inputEmail3" class="col-sm-2 control-label">Latitude</label>
          <div class="col-sm-5">
            {{ form.lat}}      
          </div>
        </div>
        <div class="form-group">
          <label for="inputEmail3" class="col-sm-2 control-label">Longitude</label>
          <div class="col-sm-5">
            {{ form.lon}}      
          </div>
          <div class="col-sm-5" style="margin-top: -30px;">
            <a id="geolocate-link" class="btn btn-md btn-primary" href="#" onclick="GeoLocate();" role="button">Get your current location</a>
          </div>          
        </div>
        <div class="form-group">
          <label for="inputEmail3" class="col-sm-2 control-label">User name</label>
          <div class="col-sm-10">
            {{ form.user_name}}      
          </div>
        </div>
        <div class="form-group">
          <label for="inputEmail3" class="col-sm-2 control-label">Location name</label>
          <div class="col-sm-6" style="margin-top: 5px;">
            {{ form.location}}
          </div>
          <div class="col-sm-4" style="margin-top: 5px;">
            <a id="geocode-link" class="btn btn-md btn-primary" href="#" onclick="GeoCode();" role="button" style="width: 100%;">Geocoding</a>
          </div>          
        </div>
          
        <div class="form-group">
          <label for="inputEmail3" class="col-sm-2 control-label">Comment</label>
          <div class="col-sm-10">
            {{ form.comment}}      
          </div>
        </div>        
        
        <div class="col-sm-offset-2 col-sm-10">
          <input type="submit" class="btn-lg btn-info">      
        </div>
      </form>      
    </div>
    <div class="col-md-6">
      <div id="bump-map"></div>
    </div>
    <h3 class="page-header">Bump Insights of others<br><span class="text-muted">Others also registered the location</span></h3>
    <div class="col-md-3">
      <h4 class="page-header"><span class="text-muted">Positive</span></h3>
    </div>
    <div class="col-md-3">
      <h4 class="page-header"><span class="text-muted">Negative</span></h3>
    </div>    
  </div>
  
</div>

<script language="javascript" type="text/javascript">
 var map;
 var BLUE_ICON_PATH = '/static/image/blue-dot.png';
 var YELLOW_ICON_PATH = '/static/image/yellow-dot.png';  
 $(document).ready(function(){
   map = new GMaps({
     div: '#bump-map',
     zoom: 12,
     lat: 35.681382,
     lng: 139.766083999
   });
   // visualization of insights data
   $.ajax({
        url: 'get_all/',
        type: 'GET',
        dataType: 'json',
        success: function(response) {
          for (var i = 0; i < response.all_insight_data.length; i++) {
            var data = response.all_insight_data[i];
            // console.log(data);
            map.addMarker({
              lat: data.lat,
              lng: data.lon,
              title: data.created_at,
              infoWindow: {
                content: '<table style="text-align: center;"><tr><td style="font-weight: bold; min-width: 100px;">Location: </td><td>' + data.location_name + '</td><tr><td style="font-weight: bold; min-width: 100px;">User Name: </td><td>' + data.user_name + '</td></tr><tr><td style="font-weight: bold; min-width: 100px;">latitude: </td><td>' + data.lat + '</td></tr><tr><td style="font-weight: bold; min-width: 100px;">longitude: </td><td>' + data.lon + '</td></tr><tr><td style="font-weight: bold; min-width: 100px;">Comment</td><td>' + data.comment + '</td></tr></table><div style="margin: 10px;"><a href="http://maps.google.com/?cbll=' + data.lat + ',' + data.lon + '&layer=c" target="_blank">Street View Link</a></div>'
              },
              icon: YELLOW_ICON_PATH,
            });
          }    
          map.addLayer('traffic');              
        }
   });
   // display twitter
   $.ajax({
     url: 'get_tweets/',
     type: 'GET',
     dataType: 'json',
     success: function(response) {
       debugger;
     }
   });      
 });
 function GeoLocate() {
   var default_str     = $("#geolocate-link").text();
   var target_ele      = $("#geolocate-link");
   target_ele.text('Now Geolocating...');
   GMaps.geolocate({
     success: function(position) {
       $("#input-lat").val(position.coords.latitude);
       $("#input-lon").val(position.coords.longitude);
       map.setCenter(position.coords.latitude, position.coords.longitude);
       map.addMarker({
         lat: position.coords.latitude,
         lng: position.coords.longitude,
         icon: BLUE_ICON_PATH,
       });                
     },
     error: function(error) {
       alert('Geolocation failed: '+error.message);
     },
     not_supported: function() {
       alert("Your browser does not support geolocation");
     },
     always: function() {
       target_ele.text(default_str);
       alert("Your current location is coorded!");
     }
   });     
 }
 function GeoCode() {
   var default_str     = $("#geocode-link").text();
   var target_ele      = $("#geocode-link");
   target_ele.text('Now Geocoding...');
   GMaps.geocode({
     address: $('#input-location').val().trim(),
     callback: function(results, status){
       if(status=='OK'){
         var latlng = results[0].geometry.location;
         $("#input-lat").val(latlng.lat());
         $("#input-lon").val(latlng.lng());
         map.setCenter(latlng.lat(), latlng.lng());
         map.addMarker({
           lat: latlng.lat(),
           lng: latlng.lng(),
           icon: BLUE_ICON_PATH,
         });
         alert("Geocoding was conducted successfully!");
       }else{
         target_ele.text(default_str);
         alert("Geocoding was failed...");
       }
       target_ele.text(default_str);       
     }
   });
 } 
</script>
{% endblock content %}
